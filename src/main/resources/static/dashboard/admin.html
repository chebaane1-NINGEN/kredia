<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Kredia</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header" style="border-bottom: 1px solid #eee; padding-bottom: 20px;">
                <a href="/"><img src="/images/logo.png" alt="Kredia Logo" style="height:40px;"></a>
            </div>
            <div class="sidebar-user">Logged in as <strong id="sidebarUser">Admin</strong></div>
            <nav>
                <a href="#" class="active" onclick="showSection('overview')">
                    <span class="nav-icon">üìä</span> Overview
                </a>
                <a href="#" onclick="showSection('users')">
                    <span class="nav-icon">üë•</span> Users & Access
                </a>
                <a href="#" onclick="showSection('kyc')">
                    <span class="nav-icon">üõ°Ô∏è</span> KYC Governance
                </a>
                <a href="#" onclick="showSection('credits')">
                    <span class="nav-icon">üí≥</span> Credit Portfolio
                </a>
                <div style="margin-top: auto; padding-top: 20px;">
                    <a href="#" onclick="logout()">
                        <span class="nav-icon">üö™</span> Logout
                    </a>
                </div>
            </nav>
        </aside>
        <main class="main-content">
            <!-- OVERVIEW (Fintech Upgrade) -->
            <div id="section-overview" class="section active">
                <div class="dashboard-header">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                        <div>
                            <h2>Fintech Command Center</h2>
                            <p class="subtitle">Advanced Portfolio Analytics & Risk Governance</p>
                        </div>
                        <div class="stat-trend glass" style="margin-bottom:10px;">
                            ‚ö° Platform Pulse: <strong class="text-success">HEALTHY</strong>
                        </div>
                    </div>
                </div>
                <!-- Dynamic Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>üìÖ Time Range:</label>
                        <select id="filterTimeRange" onchange="loadAdminStats()">
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>‚öñÔ∏è Risk Tier:</label>
                        <select id="filterRiskTier" onchange="loadAdminStats()">
                            <option value="ALL">All Tiers</option>
                            <option value="LOW">Low Risk</option>
                            <option value="MEDIUM">Medium Risk</option>
                            <option value="HIGH">High Risk</option>
                        </select>
                    </div>
                    <div class="stat-pulse">
                        <span class="pulse-dot"></span>
                        <span id="platformStatus">Live Portfolio Feed</span>
                    </div>
                </div>

                <!-- DASHBOARD MODULES -->
                <div class="dashboard-modules">
                    <!-- 1. Performance Hub -->
                    <h3 class="group-title">üöÄ Performance Hub</h3>
                    <div class="stats-grid stats-4">
                        <div class="card card-kpi" title="Total amount borrowed and approved.">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <p class="stat-label">Total Borrowed Amount</p>
                                    <p class="stat-value" id="statTotalBorrowed">0 TND</p>
                                </div>
                                <div
                                    style="background:rgba(79, 70, 229, 0.1); padding:10px; border-radius:12px; font-size:1.2rem;">
                                    üí∞</div>
                            </div>
                            <div class="stat-trend"
                                style="background:rgba(16, 185, 129, 0.1); color:var(--success-color); border:none;">
                                Portfolio Healthy</div>
                        </div>

                        <div class="card card-kpi" title="Total number of loan applications.">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <p class="stat-label">Total Applications</p>
                                    <p class="stat-value" id="statTotalLoans">0</p>
                                </div>
                                <div
                                    style="background:rgba(59, 130, 246, 0.1); padding:10px; border-radius:12px; font-size:1.2rem;">
                                    üìÑ</div>
                            </div>
                            <p class="stat-sub">Across all users</p>
                        </div>

                        <div class="card card-kpi" title="Average loan amount approved.">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <p class="stat-label">Average Loan Amount</p>
                                    <p class="stat-value" id="statAvgLoan">0 TND</p>
                                </div>
                                <div
                                    style="background:rgba(16, 185, 129, 0.1); padding:10px; border-radius:12px; font-size:1.2rem;">
                                    ‚öñÔ∏è</div>
                            </div>
                            <p class="stat-sub">Global average</p>
                        </div>

                        <div class="card card-kpi" title="Platform-wide approval rate.">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <p class="stat-label">Global Approval Rate</p>
                                    <p class="stat-value" id="statApprovalRate">0%</p>
                                </div>
                                <div
                                    style="background:rgba(245, 158, 11, 0.1); padding:10px; border-radius:12px; font-size:1.2rem;">
                                    üìà</div>
                            </div>
                            <p class="stat-sub" id="statApprovedRejected">0 Approved / 0 Total</p>
                        </div>
                    </div>

                    <!-- 2. Risk Intelligence -->
                    <h3 class="group-title">‚öñÔ∏è Risk Intelligence (AI Scoring)</h3>
                    <div class="stats-grid stats-3">
                        <div class="card card-kpi" style="border-left: 4px solid var(--success-color);">
                            <p class="stat-label">Low Risk Users</p>
                            <p class="stat-value" id="riskLow">0</p>
                            <p class="stat-sub">Score ‚â• 700</p>
                        </div>
                        <div class="card card-kpi" style="border-left: 4px solid var(--warning-color);">
                            <p class="stat-label">Medium Risk Users</p>
                            <p class="stat-value" id="riskMedium">0</p>
                            <p class="stat-sub">Score 500‚Äì699</p>
                        </div>
                        <div class="card card-kpi" style="border-left: 4px solid var(--error-color);">
                            <p class="stat-label">High Risk Users</p>
                            <p class="stat-value" id="riskHigh">0</p>
                            <p class="stat-sub">Score < 500</p>
                        </div>
                    </div>

                    <!-- 3. Visual Analytics -->
                    <h3 class="group-title">üìä Visual Portfolio Analytics</h3>
                    <div class="charts-container">
                        <div class="card chart-card">
                            <h3>üìà Loan Volume Trends (Daily)</h3>
                            <div style="height:250px;"><canvas id="volumeTrendChart"></canvas></div>
                        </div>
                        <div class="card chart-card">
                            <h3>üîÑ Approval Rate Evolution</h3>
                            <div style="height:250px;"><canvas id="approvalTrendChart"></canvas></div>
                        </div>
                        <div class="card chart-card full-width" style="grid-column: span 2;">
                            <h3>üìâ User Growth Curve</h3>
                            <div style="height:250px;"><canvas id="growthChart"></canvas></div>
                        </div>
                    </div>
                </div> <!-- End dashboard-modules -->
            </div> <!-- End section-overview -->

            <!-- AI Assistant Floating Toggle & Panel -->
            <div class="ai-toggle" id="aiToggle" onclick="toggleAiPanel()">
                <span>ü§ñ</span>
            </div>

            <div class="ai-panel minimized" id="aiPanel">
                <div class="ai-header">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="background:rgba(255,255,255,0.2); padding:8px; border-radius:10px;">ü§ñ</div>
                        <div>
                            <h4 style="margin:0;">Kredia AI Assistant</h4>
                            <span style="font-size:0.75rem; opacity:0.8;">Phase 3: Deep Reasoning Active</span>
                        </div>
                    </div>
                    <button onclick="toggleAiPanel()"
                        style="background:none; border:none; color:white; cursor:pointer; font-size:1.8rem;">&times;</button>
                </div>
                <div class="ai-messages" id="aiChatBox">
                    <div class="msg msg-ai">Hello Admin. I've analyzed the platform's current financial and risk
                        data.
                        Today's PAR(30) is under control. How can I assist you with the portfolio analysis today?
                    </div>
                </div>
                <div class="ai-input-area">
                    <input type="text" id="aiPrompt" placeholder="Ask about PAR, risk or volume..."
                        onkeypress="if(event.key==='Enter') sendAiQuery()">
                    <button class="btn btn-primary" onclick="sendAiQuery()">Send</button>
                </div>
            </div>

            <!-- USER MANAGEMENT -->
            <div id="section-users" class="section">
                <div class="section-header">
                    <h2>User Management</h2>
                    <button class="btn btn-primary"
                        onclick="document.getElementById('createEmployeeModal').classList.add('active')">+ Create
                        Employee</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersList"></tbody>
                </table>
            </div>

            <!-- KYC QUEUE -->
            <div id="section-kyc" class="section">
                <h2>Pending KYC Documents</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User ID</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Uploaded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="kycQueue"></tbody>
                </table>
            </div>

            <!-- ALL CREDITS -->
            <div id="section-credits" class="section">
                <h2>All Credits</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Rate</th>
                            <th>Term</th>
                            <th>Status</th>
                            <th>Risk</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="allCreditsList"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- CREATE EMPLOYEE MODAL -->
    <div class="modal-overlay" id="createEmployeeModal">
        <div class="modal">
            <h3>Create Employee Account</h3>
            <form id="createEmployeeForm">
                <div class="form-row">
                    <div class="form-group"><label>First Name</label><input type="text" id="empFirstName" required>
                    </div>
                    <div class="form-group"><label>Last Name</label><input type="text" id="empLastName" required></div>
                </div>
                <div class="form-group"><label>Email</label><input type="email" id="empEmail" required></div>
                <div class="form-group"><label>Phone</label><input type="tel" id="empPhone" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="empPassword" minlength="8"
                        required></div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="empRole">
                        <option value="AGENT">Agent</option>
                        <option value="AUDITOR">Auditor</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="document.getElementById('createEmployeeModal').classList.remove('active')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            checkAuth('ADMIN');
            document.getElementById('sidebarUser').textContent = 'Admin';
            await loadAdminStats();
            await loadUsers();
            await loadKycQueue();
            await loadAllCredits();
        });

        function animateValue(id, value, isCurrency = false) {
            const obj = document.getElementById(id);
            if (!obj) return;
            const start = 0;
            const end = parseFloat(value.toString().replace(/[^0-9.-]+/g, ""));
            if (isNaN(end)) {
                obj.textContent = value;
                return;
            }
            const duration = 800;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const current = progress * (end - start) + start;
                obj.textContent = isCurrency ? formatCurrency(current) : Math.round(current * 10) / 10 + (value.toString().includes('%') ? '%' : '');
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    obj.textContent = value;
                }
            };
            window.requestAnimationFrame(step);
        }

        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
            const target = document.getElementById('section-' + name);
            if (target) target.classList.add('active');
            if (event && event.target) {
                const link = event.target.closest('a');
                if (link) link.classList.add('active');
            }
        }

        let charts = {};

        async function loadAdminStats() {
            try {
                const res = await authenticatedFetch('/api/dashboard/admin');
                if (res.ok) {
                    const s = await res.json();

                    // 1. Performance Hub
                    animateValue('statTotalBorrowed', formatCurrency(s.totalBorrowedAmount), true);
                    animateValue('statTotalLoans', s.totalLoans);
                    animateValue('statAvgLoan', formatCurrency(s.averageLoanAmount), true);
                    document.getElementById('statApprovalRate').textContent = s.approvalRate.toFixed(1) + '%';
                    document.getElementById('statApprovedRejected').textContent = `${s.approvedLoans} Approved / ${s.totalLoans} Total`;

                    // 2. Risk Intelligence
                    animateValue('riskLow', s.lowRiskUsers);
                    animateValue('riskMedium', s.mediumRiskUsers);
                    animateValue('riskHigh', s.highRiskUsers);

                    updateFintechCharts(s);
                }
            } catch (err) { console.error('Stats error', err); }
        }

        function updateFintechCharts(s) {
            // 1. Volume Trend
            renderChart('volumeTrendChart', 'line', {
                labels: s.loanVolumeTrend.map(p => p.label),
                datasets: [{
                    label: 'Daily Volume (TND)',
                    data: s.loanVolumeTrend.map(p => p.value),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            });

            // 2. Approval Ratio Trend
            renderChart('approvalTrendChart', 'line', {
                labels: s.approvalRateTrend.map(p => p.label),
                datasets: [{
                    label: 'Approval Rate (%)',
                    data: s.approvalRateTrend.map(p => p.value),
                    borderColor: '#2ecc71',
                    tension: 0.4
                }]
            });

            // 3. User Growth
            renderChart('growthChart', 'line', {
                labels: s.userGrowthTrend.map(p => p.label),
                datasets: [{
                    label: 'Registered Users',
                    data: s.userGrowthTrend.map(p => p.value),
                    borderColor: '#9b59b6',
                    tension: 0.3
                }]
            });
        }

        function renderChart(id, type, data, options = {}) {
            if (charts[id]) charts[id].destroy();
            const canvas = document.getElementById(id);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            charts[id] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } },
                    ...options
                }
            });
        }

        // AI Assistant
        function toggleAiPanel() {
            const panel = document.getElementById('aiPanel');
            panel.classList.toggle('minimized');
        }

        async function sendAiQuery() {
            const promptInput = document.getElementById('aiPrompt');
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            const chatBox = document.getElementById('aiChatBox');
            chatBox.innerHTML += `<div class="msg msg-user">${prompt}</div>`;
            promptInput.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const res = await authenticatedFetch('/api/dashboard/ai/query', {
                    method: 'POST',
                    body: JSON.stringify({ prompt })
                });
                if (res.ok) {
                    const data = await res.json();
                    chatBox.innerHTML += `
                        <div class="msg msg-ai">
                            ${data.answer}
                            ${data.insight ? `<div class="ai-insight">${data.insight}</div>` : ''}
                        </div>`;
                } else {
                    chatBox.innerHTML += `<div class="msg msg-ai">Analysis engine is temporarily calibrating. Please try again.</div>`;
                }
            } catch (err) { chatBox.innerHTML += `<div class="msg msg-ai">Connection to AI node failed.</div>`; }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function loadUsers() {
            try {
                const res = await authenticatedFetch('/api/admin/users');
                if (res.ok) {
                    const users = await res.json();
                    document.getElementById('usersList').innerHTML = users.map(u => `
                        <tr>
                            <td>#${u.userId}</td>
                            <td>${u.firstName} ${u.lastName}</td>
                            <td>${u.email}</td>
                            <td><span class="status-badge">${u.role}</span></td>
                            <td><span class="status-badge status-${u.status}">${u.status}</span></td>
                            <td>${formatDate(u.createdAt)}</td>
                            <td><button class="btn btn-danger btn-sm" onclick="deleteUser(${u.userId})">Delete</button></td>
                        </tr>`).join('');
                }
            } catch (err) { console.error('Users error', err); }
        }

        async function loadKycQueue() {
            try {
                const res = await authenticatedFetch('/api/admin/kyc/pending');
                if (res.ok) {
                    const docs = await res.json();
                    const tbody = document.getElementById('kycQueue');
                    if (docs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999">No pending KYC documents.</td></tr>';
                    } else {
                        tbody.innerHTML = docs.map(d => `
                            <tr>
                                <td>#${d.kycId}</td>
                                <td>#${d.userId}</td>
                                <td>${d.documentType}</td>
                                <td><span class="status-badge status-${d.status}">${d.status}</span></td>
                                <td>${formatDate(d.uploadedAt)}</td>
                                <td>
                                    <button class="btn btn-success btn-sm" onclick="approveKyc(${d.kycId})">Approve</button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectKyc(${d.kycId})">Reject</button>
                                </td>
                            </tr>`).join('');
                    }
                }
            } catch (err) { console.error('KYC queue error', err); }
        }

        async function loadAllCredits() {
            try {
                const res = await authenticatedFetch('/api/credits');
                if (res.ok) {
                    const credits = await res.json();
                    const tbody = document.getElementById('allCreditsList');
                    if (credits.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999">No credits found.</td></tr>';
                    } else {
                        tbody.innerHTML = credits.map(c => `
                            <tr>
                                <td>#${c.creditId}</td>
                                <td>#${c.userId || 'N/A'}</td>
                                <td>${formatCurrency(c.amount)}</td>
                                <td>${c.interestRate}%</td>
                                <td>${c.termMonths}m</td>
                                <td><span class="status-badge status-${c.status}">${c.status}</span></td>
                                <td>${c.riskLevel || 'N/A'}</td>
                                <td>${formatDate(c.createdAt)}</td>
                            </tr>`).join('');
                    }
                }
            } catch (err) { console.error('Credits error', err); }
        }

        async function approveKyc(kycId) {
            try {
                const res = await authenticatedFetch(`/api/admin/kyc/${kycId}/approve`, { method: 'PUT' });
                if (res.ok) { showToast('KYC approved!', 'success'); await loadKycQueue(); await loadAdminStats(); }
                else showToast('Approval failed', 'error');
            } catch (err) { showToast('Error', 'error'); }
        }

        async function rejectKyc(kycId) {
            try {
                const res = await authenticatedFetch(`/api/admin/kyc/${kycId}/reject`, { method: 'PUT' });
                if (res.ok) { showToast('KYC rejected', 'warning'); await loadKycQueue(); await loadAdminStats(); }
                else showToast('Rejection failed', 'error');
            } catch (err) { showToast('Error', 'error'); }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            try {
                const res = await authenticatedFetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
                if (res.ok) { showToast('User deleted', 'success'); await loadUsers(); await loadAdminStats(); }
                else showToast('Delete failed', 'error');
            } catch (err) { showToast('Error', 'error'); }
        }

        // Create Employee
        document.getElementById('createEmployeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                firstName: document.getElementById('empFirstName').value,
                lastName: document.getElementById('empLastName').value,
                email: document.getElementById('empEmail').value,
                phoneNumber: document.getElementById('empPhone').value,
                passwordHash: document.getElementById('empPassword').value,
                role: document.getElementById('empRole').value
            };
            try {
                const res = await authenticatedFetch('/api/admin/users', { method: 'POST', body: JSON.stringify(data) });
                if (res.ok) {
                    showToast('Employee created!', 'success');
                    document.getElementById('createEmployeeModal').classList.remove('active');
                    document.getElementById('createEmployeeForm').reset();
                    await loadUsers();
                    await loadAdminStats();
                } else {
                    const err = await res.text();
                    showToast('Creation failed: ' + err, 'error');
                }
            } catch (err) { showToast('Error creating employee', 'error'); }
        });
    </script>
</body>

</html>